<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>結帳</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>

<body>
    <h1>購物車結帳</h1>

    <!-- 购物车明细 -->
    <div id="cart-details">
        <h2>購物車明細</h2>
        <table>
            <thead>
                <tr>
                    <th>商品名稱</th>
                    <th>數量</th>
                    <th>價格</th>
                </tr>
            </thead>
            <tbody>
                <!-- 这里将购物车中的明细动态显示 -->
                <tr>
                    <td>商品1</td>
                    <td>3</td>
                    <td>$20.00</td>
                </tr>
                <tr>
                    <td>商品2</td>
                    <td>1</td>
                    <td>$15.00</td>
                </tr>
                <!-- 可以根据购物车内容添加更多行 -->
            </tbody>
        </table>
    </div>

    <!-- 收件人信息 -->
    <div id="shipping-info">
        <h2>收件人信息</h2>
        <form>
            <label for="recipient-name">收件人名稱</label>
            <input type="text" id="recipient-name" name="recipient-name" required><br>

            <label for="recipient-address">收件人地址</label>
            <input type="text" id="recipient-address" name="recipient-address" required><br>

            <label for="recipient-phone">收件人電話</label>
            <input type="tel" id="recipient-phone" name="recipient-phone" required><br>

            <label for="payment-method">付款方式</label>
            <select id="payment-method" name="payment-method" required>
                <option value="credit-card">信用卡</option>
                <option value="paypal">PayPal</option>
                <!-- 添加更多付款方式选项 -->
            </select><br>
        </form>
    </div>

    <!-- 总金额 -->
    <div id="total-amount">
        <p><strong>總金額: <span id="total-price">0</span></strong></p>
    </div>

    <!-- 结账按钮和返回修改按钮 -->
    <div id="checkout-buttons">
        <button onclick="returnToCart()">返回修改購物車</button>
        <button id="checkout">確認結帳</button>
    </div>

    <script>
        function calculateTotal() {
            // 获取所有商品行
            const rows = $("#cart-details tbody tr");

            let total = 0;

            // 遍历每一行，计算小计并累加到总金额
            rows.each(function () {
                const price = parseFloat($(this).find("td:nth-child(3)").text().replace("$", ""));
                const quantity = parseInt($(this).find("td:nth-child(2)").text());
                total += price * quantity;
            });

            // 更新总金额显示
            $("#total-price").text("$" + total.toFixed(2));
        }

        // 初始化时计算一次总金额
        calculateTotal();

        
        // 結帳
        $('#checkout').click(function () {

            const lpaTotalAmount = $("#total-price").text().substring(1, $("#total-price").text().length);
            console.log(lpaTotalAmount);
            const lpaRecName = $("#recipient-name").val();
            const lpaSendAddress = $("#recipient-address").val();
            const lpaRecTel = $("#recipient-phone").val();


            let Data = {
                lpaSo: {
                    lpaTotalAmount: 0,
                    lpaRecName: lpaRecName,
                    lpaSendAddress: lpaSendAddress,
                    lpaRecTel: lpaRecTel
                },
                // 由購物車頁面傳來陣列資料?
                lpaSoDetails: [
                    {
                        lpaProdNo: 1,
                        lpaProdPrice: 200,
                        lpaOrdQty: 2
                    },
                    {
                        lpaProdNo: 2,
                        lpaProdPrice: 300,
                        lpaOrdQty: 1
                    }
                ]
            }

            console.log(Data);
        	
            fetch('/BuyGo/needLoginApi/newOrder', {
                method: 'POST',
                body: JSON.stringify(Data),
                headers: {
                    'Content-Type': 'application/json; charset=utf-8'
                }
            })
                .then(response => response.json())
                .then(data => {
                    alert('訂單已提交！' + data);
                    cart = []; // 清空購物車
                    // updateCart();
                })
                .catch(error => {
                    console.error('錯誤：', error);
                });
        });


        function returnToCart() {
            // 返回到购物车页面的逻辑
            // 可以使用JavaScript的window.location来跳转到购物车页面
        }
    </script>
</body>

</html>