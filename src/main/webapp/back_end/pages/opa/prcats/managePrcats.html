<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <title>BuyGo - 商品類別管理</title>

    <link href="../../../css/common/all.css" rel="stylesheet" type="text/css">
    <link href="../../../js/common/bstable/css/bootstrap.min.css" rel="stylesheet" type="text/css">
    <link href="../../../js/common/bstable/css/bootstrap-table.css" rel="stylesheet" type="text/css">
    <link href="../../../css/common/from.css" rel="stylesheet" type="text/css">

    <style>
        #msg {
            color: blue;
        }

        .-none {
            display: none;
        }

        .div_addOption {
            margin-bottom: 5px;
        }

        #addPrcats {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background-color: hsla(0, 0%, 0%, .5);
            margin: 0;
        }

        #addPrcats>article {
            background-color: white;
            width: 90%;
            max-width: 820px;
            max-height: 500px;
            border-radius: 10px;
            box-shadow: 0 0 10px #ddd;
            padding: 10px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            overflow: auto;
        }

        .find_labela {
            width: 100px;
        }
    </style>
</head>

<body>
    <p class="p_but">
        <i class="add_i"></i><a href="#" class="add_a" onClick="openAddPrcats()">新增</a>
        <!-- <i class="del_i"></i><a href="#" class="add_a">删除</a> -->
        <span style="position: absolute; right: 5px; text-align: right; white-space: nowrap;">
            <label for="sOpaPrcatsName" class="find_labela">商品類別: </label>
            <input type="text" name="sOpaPrcatsName" id="sOpaPrcatsName" class="find_input" style="width: 80px;">
            <input type="button" value="搜尋" class="find_but" id="but_find" onClick="openSearchPrcats()">
        </span>
    </p>
    <div id="prcats_table">
        <table id="table" class="table_style" style="margin: 0 auto"></table>
    </div>
    <br>
    <div id="msg" class="error"></div>

    <div id="addPrcats" class="div_form -none">
        <article>
            <h1 class="h1_style" style="font-size: 24px;">新增商品類別</h1>
            <form id="form_demo">
                <div class="div_addOption">
                    <label for="opaPrcatsName" class="find_labela">商品類別名稱: </label>
                    <input type="text" name="opaPrcatsName" id="addopaPrcatsName" class="form_input">
                </div>
                <div style="text-align: center;">
                    <button id="btnAdd" type="button" class="find_but">新增</button>
                    <button id="btnClose" type="button" class="find_but">關閉</button>
                </div>
                <div id="addMsg" class="error"></div>
            </form>
        </article>
    </div>

    <script src="../../../js/common/jquery/jQuery-2.2.0.min.js"></script>
    <script src="../../../js/common/bstable/js/bootstrap.min.js"></script>
    <script src="../../../js/common/bstable/js/bootstrap-table.js"></script>
    <script src="../../../js/common/bstable/js/bootstrap-table-zh-TW.min.js"></script>
    <script src="../../../js/common/date/js/laydate.js"></script>

    <script>
        function onEditClick(opaPrcatsNo) {
            const btn_edit = document.querySelector("#btnEdit_" + opaPrcatsNo);
            const p_opaPrcatsName = document.querySelector(`#p_${opaPrcatsNo}`);
            const input_opaPrcatsName = document.querySelector(`#input_${opaPrcatsNo}`);
            const msg = document.querySelector("#msg");
            btn_edit.classList.toggle("-on");

            p_opaPrcatsName.classList.toggle("-none");
            input_opaPrcatsName.classList.toggle("-none");

            if (btn_edit.classList.contains("-on")) {
                btn_edit.textContent = "儲存";
            } else {
                btn_edit.textContent = "編輯";
                fetch("/BuyGo/api/opa/prcats/update", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json; charset=utf-8",
                    },
                    body: JSON.stringify({
                        opaPrcatsNo: opaPrcatsNo,
                        opaPrcatsName: input_opaPrcatsName.value.trim(),
                    })
                })
                    .then(resp => resp.json())
                    .then(body => {
                        const { successful } = body;
                        if (successful) {
                            msg.className = "info";
                            msg.textContent = "編號" + opaPrcatsNo + "更新成功";
                            p_opaPrcatsName.textContent = input_opaPrcatsName.value.trim();
                        } else {
                            msg.className = "error";
                            msg.textContent = "編號" + opaPrcatsNo + "更新失敗";
                            input_opaPrcatsName.value = p_opaPrcatsName.textContent;
                        }
                    });
            }
        }

        function onRemoveClick(opaPrcatsNo) {
            if (!confirm("確定刪除編號" + opaPrcatsNo + "?")) {
                return;
            }
            fetch("/BuyGo/api/opa/prcats/remove", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ opaPrcatsNo })
            })
                .then(resp => resp.json())
                .then(body => {
                    if (body.successful) {
                        location.reload();
                    }
                });
        }

        function datetimeLocal(datetime) {
            const dt = new Date(datetime);
            dt.setMinutes(dt.getMinutes() - dt.getTimezoneOffset());
            return dt.toISOString().slice(0, 16);
        }

        $(function () {
            let data = [];
            fetch("/BuyGo/api/opa/prcats/manage", { headers: { "Content-Type": "application/json; charset=utf-8", } })
                .then(resp => resp.json())
                .then(datas => {
                    for (let i = 0; i < datas.length; i++) {
                        let prcats = {
                            opaPrcatsNo: datas[i].opaPrcatsNo,
                            opaPrcatsName: `<p id="p_${datas[i].opaPrcatsNo}">${datas[i].opaPrcatsName}</p><input type="text" id="input_${datas[i].opaPrcatsNo}" class="-none" value="${datas[i].opaPrcatsName}">`,
                            action: `<button id="btnEdit_${datas[i].opaPrcatsNo}" class="find_but" onclick="onEditClick(${datas[i].opaPrcatsNo})">編輯</button>  <button id="btnDel_${datas[i].opaPrcatsNo}" class="find_but" onclick="onRemoveClick(${datas[i].opaPrcatsNo})">刪除</button>`
                        }
                        data.push(prcats);
                    }
                    $('#table').bootstrapTable({
                        method: "get",
                        striped: true,
                        singleSelect: false,
                        pagination: true, //分頁
                        pageSize: 10,
                        pageNumber: 1,
                        search: false, //顯示搜索框
                        contentType: "application/x-www-form-urlencoded",
                        queryParams: null,
                        columns: [
                            // {
                            //     checkbox: "true",
                            //     field: 'check',
                            //     align: 'center',
                            //     valign: 'middle'
                            // }
                            // ,
                            {
                                title: "商品類別編號",
                                field: 'opaPrcatsNo',
                                align: 'center',
                                valign: 'middle'
                            },
                            {
                                title: "商品類別名稱",
                                field: 'opaPrcatsName',
                                align: 'center',
                                valign: 'middle'
                            },
                            {
                                title: "",
                                field: 'action',
                                align: 'center',
                                valign: 'middle'
                            }
                        ],
                        data: data
                    });
                });

        });
    </script>

    <script>
        const addMsg = document.querySelector("#addMsg");
        const addopaPrcatsName = document.querySelector("#addopaPrcatsName");
        const btn_addPrcats_add_el = document.querySelector("#btnAdd");

        function openAddPrcats() {
            let lightbox_el = document.querySelector("#addPrcats");
            lightbox_el.classList.remove("-none");
            addMsg.textContent = "";
        }

        const btn_addPrcats_close_el = document.querySelector("#btnClose");
        btn_addPrcats_close_el.addEventListener("click", function () {
            let lightbox_el = document.querySelector("#addPrcats");
            lightbox_el.classList.add("-none");
        });

        btn_addPrcats_add_el.addEventListener("click", function () {
            addMsg.textContent = "";
            if (addopaPrcatsName.value.trim() === "") {
                addMsg.textContent = "請輸入商品類別名稱";
                return;
            }

            fetch("/BuyGo/api/opa/prcats/add", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json; charset=utf-8",
                },
                body: JSON.stringify({
                    opaPrcatsName: addopaPrcatsName.value.trim(),
                }),
            })
                .then(resp => resp.json())
                .then(body => {
                    const { successful } = body;
                    if (successful) {
                        addMsg.className = "info";
                        addMsg.textContent = "新增成功";
                        let lightbox_el = document.querySelector("#addPrcats");
                        lightbox_el.classList.add("-none");
                        location.reload();
                    } else {
                        addMsg.className = "error";
                        addMsg.textContent = "新增失敗";
                    }
                });
        });
    </script>
    <script>
        function openSearchPrcats() {
            let data = [];
            const sOpaPrcatsName = document.querySelector("#sOpaPrcatsName");
            if (sOpaPrcatsName.value.trim() === "") {
                location.reload();
            } else {
                fetch("/BuyGo/api/opa/prcats/search", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json; charset=utf-8",
                    },
                    body: JSON.stringify({
                        opaPrcatsName: sOpaPrcatsName.value.trim(),
                    }),
                })
                    .then(resp => resp.json())
                    .then(datas => {
                        for (let i = 0; i < datas.length; i++) {
                            let prcats = {
                                opaPrcatsNo: datas[i].opaPrcatsNo,
                                opaPrcatsName: `<p id="p_${datas[i].opaPrcatsNo}">${datas[i].opaPrcatsName}</p><input type="text" id="input_${datas[i].opaPrcatsNo}" class="-none" value="${datas[i].opaPrcatsName}"`,
                                action: `<button id="btnEdit_${datas[i].opaPrcatsNo}" class="find_but" onclick="onEditClick(${datas[i].opaPrcatsNo})">編輯</button>  <button id="btnDel_${datas[i].opaPrcatsNo}" class="find_but" onclick="onRemoveClick(${datas[i].opaPrcatsNo})">刪除</button>`
                            }
                            data.push(prcats);
                        }
                        $('#prcats_table').html(`<table id="table" class="table_style" style="margin: 0 auto"></table>`);
                        $('#table').bootstrapTable({
                            method: "get",
                            striped: true,
                            singleSelect: false,
                            pagination: true, //分頁
                            pageSize: 10,
                            pageNumber: 1,
                            search: false, //顯示搜索框
                            contentType: "application/x-www-form-urlencoded",
                            queryParams: null,
                            columns: [
                                // {
                                //     checkbox: "true",
                                //     field: 'check',
                                //     align: 'center',
                                //     valign: 'middle'
                                // }
                                // ,
                                {
                                    title: "商品類別編號",
                                    field: 'opaPrcatsNo',
                                    align: 'center',
                                    valign: 'middle'
                                },
                                {
                                    title: "商品類別名稱",
                                    field: 'opaPrcatsName',
                                    align: 'center',
                                    valign: 'middle'
                                },
                                {
                                    title: "",
                                    field: 'action',
                                    align: 'center',
                                    valign: 'middle'
                                }
                            ],
                            data: data
                        });
                    });
            }
        }
    </script>
</body>

</html>