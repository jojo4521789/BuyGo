<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <title>Document</title>

    <link href="../../../css/common/all.css" rel="stylesheet" type="text/css">
    <link href="../../../js/common/bstable/css/bootstrap.min.css" rel="stylesheet" type="text/css">
    <link href="../../../js/common/bstable/css/bootstrap-table.css" rel="stylesheet" type="text/css">
    <link href="../../../css/common/from.css" rel="stylesheet" type="text/css">

    <style>
        #msg {
            color: blue;
        }

        .-none {
            display: none;
        }

        .lightbox {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background-color: hsla(0, 0%, 0%, .5);
            margin: 0;
        }

        .lightbox>article {
            background-color: white;
            width: 90%;
            max-width: 820px;
            max-height: 500px;
            border-radius: 10px;
            box-shadow: 0 0 10px #ddd;
            padding: 10px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            overflow: auto;
        }

        .prod_label {
            width: 100px;
            margin: 0;
            text-align: right;
        }

        .div_addOption {
            margin-bottom: 5px;
        }

        .upload_inputfile {
            width: .1px;
            height: .1px;
            opacity: 0;
            overflow: hidden;
            position: absolute;
            z-index: -1;
        }

        .upload_btn {
            display: inline-block;
            font-weight: 600;
            color: #fff;
            text-align: center;
            min-width: 116px;
            transition: all .3s ease;
            cursor: pointer;
            border: 2px solid;
            background-color: #00a0e9;
            border-color: #00a0e9;
            border-radius: 10px;
            margin-left: 100px;
        }

        .upload_btn:hover {
            background-color: unset;
            color: #00a0e9;
            transition: all .3s ease;
        }

        .upload_img-wrap {
            display: flex;
            flex-wrap: wrap;
            margin: 0 -10px;
        }

        .upload_img-box {
            width: 200px;
            padding: 0 10px;
            margin-bottom: 12px;
        }

        .upload_img-close {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: rgba(0, 0, 0, 0.5);
            position: absolute;
            top: 10px;
            right: 10px;
            text-align: center;
            line-height: 24px;
            z-index: 1;
            cursor: pointer;
        }

        .upload_img-close:after {
            content: '\2716';
            font-size: 14px;
            color: white;
        }

        .img-bg {
            background-repeat: no-repeat;
            background-position: center;
            background-size: cover;
            position: relative;
            padding-bottom: 100%;
        }


        * {
            transition: all 0.5s ease;
        }

        #thumbnails {
            text-align: center;
        }

        #thumbnails>img {
            width: 100px;
            height: 100px;
            margin: 10px;
            cursor: pointer;
            box-shadow: 2px 2px 10px 5px #b8b8b8;
            border-radius: 10px;
        }

        #thumbnails>img:hover {
            transform: scale(1.05)
        }

        #img_main_view {
            width: 400px;
            /* height: 400px; */
            object-fit: cover;
            display: block;
            margin: 20px auto;
            box-shadow: 2px 2px 10px 5px #b8b8b8;
            border-radius: 10px;

        }

        @media only screen and (max-width:480px) {
            #img_main_view {
                width: 100%;
            }

            #thumbnails>img {
                width: 50px;
                height: 50px;
            }
        }
    </style>
</head>

<body>
    <p class="p_but">
        <i class="add_i"></i><a href="#" class="add_a" onClick="openAddProd()">新增</a>
        <!-- <i class="del_i"></i><a href="#" class="add_a" onClick="">删除</a> -->
        <span style="position: absolute; right: 5px; text-align: right; white-space: nowrap;">
            <label for="sOpaProdName" class="prod_label">商品: </label>
            <input type="text" name="sOpaProdName" id="sOpaProdName" class="find_input" style="width: 80px;">
            <input type="button" value="搜尋" class="find_but" id="but_find" onClick="openSearchProd()">
        </span>
    </p>
    <div id="prod_table">
        <table id="table" class="table_style" style="margin: 0 auto"></table>
    </div>
    <br>
    <div id="msg" class="error"></div>

    <div id="addProd" class="lightbox div_form -none">
        <article>
            <h1 class="h1_style" style="font-size: 24px;">新增商品</h1>
            <form id="form_demo">
                <br>
                <div class="div_addOption">
                    <label for="slOpaPrcatsName" class="prod_label">商品類別: </label>
                    <select name="slOpaPrcatsName" id="slOpaPrcatsName" class="form_input">
                        <option disabled selected>--請選擇商品類別--</option>
                    </select>
                </div>
                <div class="div_addOption">
                    <label for="opaProdName" class="prod_label">商品名稱: </label>
                    <input type="text" name="opaProdName" id="addOpaProdName" class="form_input">
                </div>
                <div class="div_addOption">
                    <label for="opaProdStockQty" class="prod_label">庫存數量: </label>
                    <input type="text" name="opaProdStockQty" id="addOpaProdStockQty" class="form_input">
                </div>
                <div class="div_addOption">
                    <label for="opaProdPrice" class="prod_label">商品價格: </label>
                    <input type="text" name="opaProdPrice" id="addOpaProdPrice" class="form_input">
                </div>
                <div class="div_addOption">
                    <label for="opaProdContent" class="prod_label">商品內容: </label>
                    <textarea name="opaProdContent" id="addOpaProdContent" class="form_input"
                        style="max-width: 640px; height: 80px; overflow: auto; resize: none;"></textarea>
                </div>
                <div class="div_addOption">
                    <label for="opaProdUrl" class="prod_label">商品網址: </label>
                    <input type="text" name="opaProdUrl" id="addOpaProdUrl" class="form_input">
                </div>
                <div class="div_addOption">
                    <div class="upload_box">
                        <div class="upload_btn-box">
                            <label class="upload_btn">
                                <p style="margin: 0;">上傳商品圖片</p>
                                <input type="file" name="opaProdPic" class="upload_inputfile"
                                    accept="image/jpeg, image/png, image/jpg, image/gif" multiple>
                            </label>
                        </div>
                        <div class="upload_img-wrap"></div>
                    </div>
                </div>
                <div style="text-align: center;">
                    <button id="btnAdd" type="button" class="find_but">新增</button>
                    <button id="btnClose" type="button" class="find_but">關閉</button>
                </div>
                <div id="addMsg" class="error"></div>
            </form>
        </article>
    </div>

    <div id="viewProdDetail" class="lightbox div_form -none">
        <article>
            <h1 class="h1_style" style="font-size: 24px;">查看商品詳情</h1>
            <form id="form_demo">
                <br>
                <div id="allDetailOption">
                    <div class="div_detailOption">
                        <label class="prod_label">商品編號: </label>
                        <span id="span_opaProdNo_view"></span>
                    </div>
                    <div class="div_detailOption">
                        <label class="prod_label">商品名稱: </label>
                        <span id="span_opaProdName_view"></span>
                        <input type="text" id="input_opaProdName_view" class="-none">
                    </div>
                    <div class="div_detailOption">
                        <label class="prod_label">庫存數量: </label>
                        <span id="span_opaProdStockQty_view"></span>
                        <input type="text" id="input_opaProdStockQty_view" class="-none">
                    </div>
                    <div class="div_detailOption">
                        <label class="prod_label">出貨數量: </label>
                        <span id="span_opaProdShipQty_view"></span>
                    </div>
                    <div class="div_detailOption">
                        <label class="prod_label">商品價格: </label>
                        <span id="span_opaProdPrice_view"></span>
                        <input type="text" id="input_opaProdPrice_view" class="-none">
                    </div>
                    <div class="div_detailOption">
                        <label class="prod_label">商品內容: </label>
                        <span id="span_opaProdContent_view"></span>
                        <textarea id="textarea_opaProdContent_view" class="-none"></textarea>
                    </div>
                    <div class="div_detailOption">
                        <label class="prod_label">商品網址: </label>
                        <a id="a_opaProdUrl_view" href="#"></a>
                        <input type="text" id="input_opaProdUrl_view" class="-none">
                    </div>
                    <div class="div_detailOption">
                        <label class="prod_label">商品類別: </label>
                        <span id="span_opaPrcatsName_view"></span>
                        <select id="sl_opaPrcatsName_view" class="-none"></select>
                    </div>
                    <div class="div_detailOption">
                        <label class="prod_label">商品狀態: </label>
                        <span id="span_opaProdStatus_val" style="display: none;"></span>
                        <span id="span_opaProdStatus_view"></span>
                    </div>
                    <div class="div_detailOption">
                        <label class="prod_label">更新日期: </label>
                        <span id="span_opaProdUpdate_view"></span>
                    </div>
                </div>
                <div class="div_detailOption_img">
                    <div id="img_view_box">
                        <img id="img_main_view" src="" alt="無法載入圖片">
                        <div id="thumbnails"></div>
                    </div>
                    <div class="upload_box img_upload_box -none">
                        <div class="upload_btn-box">
                            <label class="upload_btn">
                                <p style="margin: 0;">上傳商品圖片</p>
                                <input type="file" class="upload_inputfile"
                                    accept="image/jpeg, image/png, image/jpg, image/gif" multiple>
                            </label>
                        </div>
                        <div class="upload_img-wrap img_upload_img-wrap"></div>
                    </div>
                </div>

                <div style="text-align: center;">
                    <button id="btnEdit_viewProdDetail" type="button" class="find_but">編輯</button>
                    <button id="btnClose_viewProdDetail" type="button" class="find_but">關閉</button>
                </div>
            </form>
        </article>
    </div>

    <script src="../../../js/common/jquery/jQuery-2.2.0.min.js"></script>
    <script src="../../../js/common/bstable/js/bootstrap.min.js"></script>
    <script src="../../../js/common/bstable/js/bootstrap-table.js"></script>
    <script src="../../../js/common/bstable/js/bootstrap-table-zh-TW.min.js"></script>
    <script src="../../../js/common/date/js/laydate.js"></script>

    <script>
        let editFlag = false;
        let opaPrpicsNoArray = [];
        function onDetailClick(opaProdNo) {
            const viewProdDetail = document.querySelector("#viewProdDetail");
            viewProdDetail.classList.remove("-none");
            $(".img_upload_img-wrap").html("");
            opaPrpicsNoArray = [];
            fetch("/BuyGo/api/opa/prod/selectById",
                {
                    method: "POST",
                    headers: { "Content-Type": "application/json; charset=utf-8", },
                    body: JSON.stringify({
                        opaProdNo: opaProdNo
                    })
                })
                .then(resp => resp.json())
                .then(prod => {
                    $("#span_opaProdNo_view").text(prod.opaProdNo);
                    $("#span_opaProdName_view").text(prod.opaProdName);
                    $("#span_opaProdStockQty_view").text(prod.opaProdStockQty);
                    $("#span_opaProdShipQty_view").text(prod.opaProdShipQty);
                    $("#span_opaProdPrice_view").text(prod.opaProdPrice);
                    $("#span_opaProdContent_view").text(prod.opaProdContent);
                    $("#a_opaProdUrl_view").attr("href", prod.opaProdUrl);
                    $("#a_opaProdUrl_view").text(prod.opaProdUrl);
                    $("#span_opaPrcatsName_view").text(prod.prcats.opaPrcatsName);
                    $("#span_opaProdStatus_val").text(prod.opaProdStatus);
                    $("#span_opaProdStatus_view").text(prod.opaProdStatus === 0 ? "未上架" : "已上架");
                    $("#span_opaProdUpdate_view").text(prod.opaProdUpdate);
                    if (prod.prpicsList.length !== 0) {
                        $("#img_main_view").attr("src", prod.prpicsList[0].opaProdPicture);
                        let prpics_el = "";
                        for (let prpic of prod.prpicsList) {
                            opaPrpicsNoArray.push(prpic.opaPrpicsNo);
                            let img_id = "img_" + prpic.opaPrpicsNo;
                            prpics_el += `<img id="img_${prpic.opaPrpicsNo}" src="${prpic.opaProdPicture}" onclick="viewImgs(this)">`;
                            var html = `<div class='upload_img-box'><div id="${prpic.opaPrpicsNo}" style='background-image: url(${prpic.opaProdPicture})' data-number='${$(".upload_img-close").length}' data-file='img_${prpic.opaPrpicsNo}' class='img-bg old_img-bg'><div class='upload_img-close'></div></div></div>`;
                            $(".img_upload_img-wrap").append(html);
                        }
                        $("#thumbnails").html(prpics_el);
                    } else {
                        $("#img_main_view").attr("src", "../../../img/common/Image_not_available.png");
                    }
                })
        }

        $("#btnClose_viewProdDetail").on("click", function () {
            $("#viewProdDetail").addClass("-none");
            $("#allDetailOption").html(allDetailOption_innerHtml);
            $("#img_view_box").removeClass("-none");
            $(".img_upload_box").addClass("-none")
            $("#btnEdit_viewProdDetail").text("編輯");
            $("#btnEdit_viewProdDetail").removeClass("-on");
            if (editFlag) {
                location.reload();
            }
        });

        $("#btnEdit_viewProdDetail").on("click", function () {

            $("#span_opaProdName_view").toggleClass("-none");
            $("#input_opaProdName_view").toggleClass("-none");

            $("#span_opaProdStockQty_view").toggleClass("-none");
            $("#input_opaProdStockQty_view").toggleClass("-none");

            $("#span_opaProdPrice_view").toggleClass("-none");
            $("#input_opaProdPrice_view").toggleClass("-none");

            $("#span_opaProdContent_view").toggleClass("-none");
            $("#textarea_opaProdContent_view").toggleClass("-none");

            $("#a_opaProdUrl_view").toggleClass("-none");
            $("#input_opaProdUrl_view").toggleClass("-none");

            $("#span_opaPrcatsName_view").toggleClass("-none");
            $("#sl_opaPrcatsName_view").toggleClass("-none");

            $("#img_view_box").toggleClass("-none");
            $(".img_upload_box").toggleClass("-none");

            $("#btnEdit_viewProdDetail").toggleClass("-on");
            if ($("#btnEdit_viewProdDetail").hasClass("-on")) {
                $("#btnEdit_viewProdDetail").text("儲存");
                $("#sl_opaPrcatsName_view").html("");
                fetch("/BuyGo/api/opa/prcats/manage", { headers: { "Content-Type": "application/json; charset=utf-8", } })
                    .then(resp => resp.json())
                    .then(prcats => {
                        let selected_opaPrcatsNo;
                        for (let i = 0; i < prcats.length; i++) {
                            let option = `<option value="${prcats[i].opaPrcatsNo}">${prcats[i].opaPrcatsName}</option>`
                            $("#sl_opaPrcatsName_view").append(option);
                            if ($("#span_opaPrcatsName_view").text() === prcats[i].opaPrcatsName) {
                                selected_opaPrcatsNo = prcats[i].opaPrcatsNo;
                            }
                        }
                        $("#sl_opaPrcatsName_view").val(selected_opaPrcatsNo);
                    });
                $("#input_opaProdName_view").val($("#span_opaProdName_view").text());
                $("#input_opaProdStockQty_view").val($("#span_opaProdStockQty_view").text());
                $("#input_opaProdPrice_view").val($("#span_opaProdPrice_view").text());
                $("#textarea_opaProdContent_view").val($("#span_opaProdContent_view").text());
                $("#input_opaProdUrl_view").val($("#a_opaProdUrl_view").text());
            } else {
                $("#btnEdit_viewProdDetail").text("編輯");
                let imgIdArray = [];
                let img_els = document.querySelectorAll(".img-bg");
                for (let el of img_els) {
                    imgIdArray.push(parseInt(el.id));
                }
                for (let old_opaPrpicsNo of opaPrpicsNoArray) {
                    if (imgIdArray.indexOf(old_opaPrpicsNo) < 0) {
                        fetch("/BuyGo/api/opa/prpics/remove", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ opaPrpicsNo: old_opaPrpicsNo })
                        })
                            .then(resp => resp.json())
                            .then(body => {
                                if (!body.successful) {
                                    console.log("刪除圖片失敗");
                                }
                            });
                    }
                }

                let opaProdNo = $("#span_opaProdNo_view").text();

                let prpicsList = getImgBase64Array();
                if (prpicsList !== null) {
                    for (let prpics of prpicsList) {
                        prpics.opaProdNo = opaProdNo;
                        addProdImgs(prpics);
                    }
                }

                $("#thumbnails").html("");
                const img_upload_box_els = document.querySelectorAll(".img_upload_img-wrap > div");
                if (img_upload_box_els !== null) {
                    for (let img_upload_box_el of img_upload_box_els) {
                        const img_el = img_upload_box_el.querySelector("div");
                        let style = img_el.currentStyle || window.getComputedStyle(img_el, false);
                        let img_url = style.backgroundImage.slice(4, -1).replace(/"/g, "");
                        let edit_prpics_el = `<img src="${img_url}" onclick="viewImgs(this)">`;
                        $("#thumbnails").append(edit_prpics_el);
                    }
                    $("#img_main_view").attr("src", $("#thumbnails > img").attr("src"));
                } else {
                    $("#img_main_view").attr("src", "../../../img/common/Image_not_available.png");
                }

                fetch("/BuyGo/api/opa/prod/update", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json; charset=utf-8",
                    },
                    body: JSON.stringify({
                        opaProdNo: opaProdNo,
                        opaPrcatsNo: $("#sl_opaPrcatsName_view").val(),
                        opaProdName: $("#input_opaProdName_view").val().trim(),
                        opaProdStockQty: $("#input_opaProdStockQty_view").val().trim(),
                        opaProdShipQty: $("#span_opaProdShipQty_view").text(),
                        opaProdPrice: $("#input_opaProdPrice_view").val().trim(),
                        opaProdContent: $("#textarea_opaProdContent_view").val().trim(),
                        opaProdUrl: $("#input_opaProdUrl_view").val().trim(),
                        opaProdStatus: $("#span_opaProdStatus_val").text(),
                    })
                })
                    .then(resp => resp.json())
                    .then(body => {
                        const { successful } = body;
                        const msg = document.querySelector("#msg");
                        if (successful) {
                            msg.className = "info";
                            msg.textContent = "編號" + opaProdNo + "更新成功";
                            $("#span_opaProdName_view").text($("#input_opaProdName_view").val().trim());
                            $("#span_opaProdStockQty_view").text($("#input_opaProdStockQty_view").val().trim());
                            $("#span_opaProdPrice_view").text($("#input_opaProdPrice_view").val().trim());
                            $("#span_opaProdContent_view").text($("#textarea_opaProdContent_view").val().trim());
                            $("#a_opaProdUrl_view").attr("href", $("#input_opaProdUrl_view").val().trim());
                            $("#a_opaProdUrl_view").text($("#input_opaProdUrl_view").val().trim());
                            $("#span_opaPrcatsName_view").text($("#sl_opaPrcatsName_view option:selected").text());
                            editFlag = true;
                        } else {
                            msg.className = "error";
                            msg.textContent = "編號" + opaProdNo + "更新失敗";
                        }
                    });

                const add_img_els = document.querySelectorAll(".add_img-bg");
                for (let add_img_el of add_img_els) {
                    add_img_el.classList.remove("add_img-bg");
                    add_img_el.classList.add("old_img-bg");
                }
            }
        });

        function onEditClick(opaProdNo) {
            const btn_edit = document.querySelector("#btnEdit_" + opaProdNo);
            const p_opaProdName = document.querySelector(`#p_${opaProdNo}`);
            const input_opaProdName = document.querySelector(`#input_${opaProdNo}`);
            const msg = document.querySelector("#msg");
            btn_edit.classList.toggle("-on");

            p_opaProdName.classList.toggle("-none");
            input_opaProdName.classList.toggle("-none");

            if (btn_edit.classList.contains("-on")) {
                btn_edit.textContent = "儲存";
            } else {
                btn_edit.textContent = "編輯";
                fetch("/BuyGo/api/opa/prod/update", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json; charset=utf-8",
                    },
                    body: JSON.stringify({
                        opaProdNo: opaProdNo,
                        opaProdName: input_opaProdName.value.trim(),
                    })
                })
                    .then(resp => resp.json())
                    .then(body => {
                        const { successful } = body;
                        if (successful) {
                            msg.className = "info";
                            msg.textContent = "編號" + opaProdNo + "更新成功";
                            p_opaProdName.textContent = input_opaProdName.value.trim();
                        } else {
                            msg.className = "error";
                            msg.textContent = "編號" + opaProdNo + "更新失敗";
                            input_opaProdName.value = p_opaProdName.textContent;
                        }
                    });
            }
        }


        function datetimeLocal(datetime) {
            const dt = new Date(datetime);
            dt.setMinutes(dt.getMinutes() - dt.getTimezoneOffset());
            return dt.toISOString().slice(0, 16);
        }

        $(function () {
            let data = [];
            fetch("/BuyGo/api/opa/prod/manage", { headers: { "Content-Type": "application/json; charset=utf-8", } })
                .then(resp => resp.json())
                .then(datas => {
                    for (let i = 0; i < datas.length; i++) {
                        let prpics_url = "../../../img/common/Image_not_available.png";
                        if (datas[i].prpicsList.length !== 0) {
                            prpics_url = datas[i].prpicsList[0].opaProdPicture;
                        }
                        let prod = {
                            prpics: `<img src="${prpics_url}" alt="error" style="width: 50px; height: 50px;">`,
                            opaProdNo: datas[i].opaProdNo,
                            opaProdName: `<p id="p_ProdName_${datas[i].opaProdNo}">${datas[i].opaProdName}</p><input type="text" id="input_ProdName_${datas[i].opaProdNo}" class="-none" value="${datas[i].opaProdName}">`,
                            opaProdStockQty: `<p id="p_ProdStockQty_${datas[i].opaProdNo}">${datas[i].opaProdStockQty}</p><input type="text" id="input_ProdStockQty_${datas[i].opaProdNo}" class="-none" value="${datas[i].opaProdStockQty}">`,
                            opaProdPrice: `<p id="p_ProdPrice_${datas[i].opaProdNo}">${datas[i].opaProdPrice}</p><input type="text" id="input_ProdPrice_${datas[i].opaProdNo}" class="-none" value="${datas[i].opaProdPrice}">`,
                            opaPrcatsName: datas[i].prcats.opaPrcatsName,
                            opaProdStatus: datas[i].opaProdStatus === 0 ? "未上架" : "已上架",
                            opaProdUpdate: datas[i].opaProdUpdate,
                            action: `<button id="btnDetail_${datas[i].opaProdNo}" class="find_but" onclick="onDetailClick(${datas[i].opaProdNo})">商品詳情</button>  <button id="btnDel_${datas[i].opaProdNo}" class="find_but" onclick="onRemoveClick(${datas[i].opaProdNo})">刪除</button>`
                        }
                        data.push(prod);
                    }
                    $('#table').bootstrapTable({
                        method: "get",
                        striped: true,
                        singleSelect: false,
                        pagination: true, //分頁
                        pageSize: 10,
                        pageNumber: 1,
                        search: false, //顯示搜索框
                        contentType: "application/x-www-form-urlencoded",
                        queryParams: null,
                        columns: [
                            // {
                            //     checkbox: "true",
                            //     field: 'check',
                            //     align: 'center',
                            //     valign: 'middle'
                            // },
                            {
                                title: "商品圖片",
                                field: 'prpics',
                                align: 'center',
                                valign: 'middle'
                            },
                            {
                                title: "商品編號",
                                field: 'opaProdNo',
                                align: 'center',
                                valign: 'middle'
                            },
                            {
                                title: "商品名稱",
                                field: 'opaProdName',
                                align: 'center',
                                valign: 'middle'
                            },
                            {
                                title: "庫存數量",
                                field: 'opaProdStockQty',
                                align: 'center',
                                valign: 'middle'
                            },
                            {
                                title: "商品價格",
                                field: 'opaProdPrice',
                                align: 'center',
                                valign: 'middle'
                            },
                            {
                                title: "商品類別",
                                field: 'opaPrcatsName',
                                align: 'center',
                                valign: 'middle'
                            },
                            {
                                title: "商品狀態",
                                field: 'opaProdStatus',
                                align: 'center',
                                valign: 'middle'
                            },
                            {
                                title: "更新日期",
                                field: 'opaProdUpdate',
                                align: 'center',
                                valign: 'middle'
                            },
                            {
                                title: "",
                                field: 'action',
                                align: 'center',
                                valign: 'middle'
                            }
                        ],
                        data: data
                    });
                });
        });

        let allDetailOption_innerHtml = `
            <div class="div_detailOption">
                <label class="prod_label">商品編號: </label>
                <span id="span_opaProdNo_view"></span>
            </div>
            <div class="div_detailOption">
                <label class="prod_label">商品名稱: </label>
                <span id="span_opaProdName_view"></span>
                <input type="text" id="input_opaProdName_view" class="-none">
            </div>
            <div class="div_detailOption">
                <label class="prod_label">庫存數量: </label>
                <span id="span_opaProdStockQty_view"></span>
                <input type="text" id="input_opaProdStockQty_view" class="-none">
            </div>
            <div class="div_detailOption">
                <label class="prod_label">出貨數量: </label>
                <span id="span_opaProdShipQty_view"></span>
            </div>
            <div class="div_detailOption">
                <label class="prod_label">商品價格: </label>
                <span id="span_opaProdPrice_view"></span>
                <input type="text" id="input_opaProdPrice_view" class="-none">
            </div>
            <div class="div_detailOption">
                <label class="prod_label">商品內容: </label>
                <span id="span_opaProdContent_view"></span>
                <textarea id="textarea_opaProdContent_view" class="-none"></textarea>
            </div>
            <div class="div_detailOption">
                <label class="prod_label">商品網址: </label>
                <a id="a_opaProdUrl_view" href="#"></a>
                <input type="text" id="input_opaProdUrl_view" class="-none">
            </div>
            <div class="div_detailOption">
                <label class="prod_label">商品類別: </label>
                <span id="span_opaPrcatsName_view"></span>
                <select id="sl_opaPrcatsName_view" class="-none"></select>
            </div>
            <div class="div_detailOption">
                <label class="prod_label">商品狀態: </label>
                <span id="span_opaProdStatus_val" style="display: none;"></span>
                <span id="span_opaProdStatus_view"></span>
            </div>
            <div class="div_detailOption">
                <label class="prod_label">更新日期: </label>
                <span id="span_opaProdUpdate_view"></span>
            </div>`;
    </script>

    <script>
        const addMsg = document.querySelector("#addMsg");
        const slOpaPrcatsName = document.querySelector("#slOpaPrcatsName");
        const addOpaProdName = document.querySelector("#addOpaProdName");
        const addOpaProdStockQty = document.querySelector("#addOpaProdStockQty");
        const addOpaProdPrice = document.querySelector("#addOpaProdPrice");
        const addOpaProdContent = document.querySelector("#addOpaProdContent");
        const addOpaProdUrl = document.querySelector("#addOpaProdUrl");
        const btn_addProd_add_el = document.querySelector("#btnAdd");

        function openAddProd() {
            let lightbox_el = document.querySelector("#addProd");
            lightbox_el.classList.remove("-none");
            addMsg.textContent = "";
            document.querySelector(".upload_img-wrap").innerHTML = "";
            slOpaPrcatsName.innerHTML = `<option disabled selected>--請選擇商品類別--</option>`;
            fetch("/BuyGo/api/opa/prcats/manage", { headers: { "Content-Type": "application/json; charset=utf-8", } })
                .then(resp => resp.json())
                .then(prcats => {
                    for (let i = 0; i < prcats.length; i++) {
                        const option = document.createElement("option");
                        option.value = prcats[i].opaPrcatsNo;
                        option.textContent = prcats[i].opaPrcatsName;
                        slOpaPrcatsName.insertAdjacentElement("beforeend", option);
                    }
                });
        }

        const btn_addProd_close_el = document.querySelector("#btnClose");
        btn_addProd_close_el.addEventListener("click", function () {
            let lightbox_el = document.querySelector("#addProd");
            lightbox_el.classList.add("-none");
            document.querySelector(".upload_img-wrap").innerHTML = "";
        });

        btn_addProd_add_el.addEventListener("click", async function () {
            addMsg.textContent = "";
            if (slOpaPrcatsName.selectedIndex === 0) {
                addMsg.textContent = "請選擇商品類別";
                return;
            }
            if (addOpaProdName.value.trim() === "") {
                addMsg.textContent = "請輸入商品名稱";
                return;
            }
            if (addOpaProdStockQty.value.trim() === "") {
                addMsg.textContent = "請輸入庫存數量";
                return;
            }
            if (isNaN(addOpaProdStockQty.value.trim())) {
                addMsg.textContent = "庫存數量輸入錯誤";
                return;
            }
            if (addOpaProdPrice.value.trim() === "") {
                addMsg.textContent = "請輸入商品價格";
                return;
            }
            if (isNaN(addOpaProdPrice.value.trim())) {
                addMsg.textContent = "商品價格輸入錯誤";
                return;
            }
            if (addOpaProdContent.value.trim() === "") {
                addMsg.textContent = "請輸入商品內容";
                return;
            }
            if (addOpaProdUrl.value.trim() === "") {
                addMsg.textContent = "請輸入商品網址";
                return;
            }
            let opaProdNo;
            fetch("/BuyGo/api/opa/prod/add", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json; charset=utf-8",
                },
                body: JSON.stringify({
                    opaPrcatsNo: slOpaPrcatsName.value.trim(),
                    opaProdName: addOpaProdName.value.trim(),
                    opaProdStockQty: addOpaProdStockQty.value.trim(),
                    opaProdPrice: addOpaProdPrice.value.trim(),
                    opaProdContent: addOpaProdContent.value.trim(),
                    opaProdUrl: addOpaProdUrl.value.trim(),
                }),
            })
                .then(resp => resp.json())
                .then(body => {
                    const { successful } = body;
                    if (successful) {
                        let prpicsList = getImgBase64Array();
                        if (prpicsList !== null) {
                            for (let prpics of prpicsList) {
                                prpics.opaProdNo = body.opaProdNo;
                                addProdImgs(prpics);
                            }
                        }
                        let lightbox_el = document.querySelector("#addProd");
                        lightbox_el.classList.add("-none");
                        location.reload();
                    } else {
                        addMsg.className = "error";
                        addMsg.textContent = "新增商品失敗";
                        document.querySelector(".upload_img-wrap").innerHTML = "";
                    }
                });
        });

        function addProdImgs(prpics) {
            fetch("/BuyGo/api/opa/prpics/add",
                {
                    method: "POST",
                    headers: { "Content-Type": "application/json; charset=utf-8", },
                    body: JSON.stringify(prpics)
                })
                .then(resp => resp.json())
                .then(body => {
                    const { successful } = body;
                    if (!successful) {
                        addMsg.className = "error";
                        addMsg.textContent = "新增商品圖片失敗";
                    }
                });
        }
    </script>

    <script>
        function onRemoveClick(opaProdNo) {
            if (!confirm("確定刪除編號" + opaProdNo + "?")) {
                return;
            }

            fetch("/BuyGo/api/opa/prod/selectById", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ opaProdNo })
            })
                .then(resp => resp.json())
                .then(body => {
                    console.log(body.prpicsList);
                    for (let prpics of body.prpicsList) {
                        fetch("/BuyGo/api/opa/prpics/remove", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ opaPrpicsNo: prpics.opaPrpicsNo })
                        })
                            .then(resp => resp.json())
                            .then(body => {
                                if (!body.successful) {
                                    console.log(body.message);
                                }
                            });
                    }
                })
                .then(() => {
                    fetch("/BuyGo/api/opa/prod/remove", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ opaProdNo })
                    })
                        .then(resp => resp.json())
                        .then(body => {
                            if (body.successful) {
                                location.reload();
                            } else {
                                console.log(body.message);
                            }
                        });
                });
        }
    </script>

    <script>
        function openSearchProd() {
            let data = [];
            const sOpaProdName = document.querySelector("#sOpaProdName");
            if (sOpaProdName.value.trim() === "") {
                location.reload();
            } else {
                fetch("/BuyGo/api/opa/prod/selectByName", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json; charset=utf-8",
                    },
                    body: JSON.stringify({
                        opaProdName: sOpaProdName.value.trim(),
                    }),
                })
                    .then(resp => resp.json())
                    .then(datas => {
                        for (let i = 0; i < datas.length; i++) {
                            let prpics_url = datas[i].prpicsList[0].opaProdPicture !== null ? datas[i].prpicsList[0].opaProdPicture : "../ ../back_end/img/Image_not_availab le.png";
                            let prod = {
                                prpics: `<img src="${prpics_url}" alt="error" style="width: 50px; height: 50px;">`,
                                opaProdNo: datas[i].opaProdNo,
                                opaProdName: `<p id="p_ProdName_${datas[i].opaProdNo}">${datas[i].opaProdName}</p><input type="text" id="input_ProdName_${datas[i].opaProdNo}" class="-none" value="${datas[i].opaProdName}">`,
                                opaProdStockQty: `<p id="p_ProdStockQty_${datas[i].opaProdNo}">${datas[i].opaProdStockQty}</p><input type="text" id="input_ProdStockQty_${datas[i].opaProdNo}" class="-none" value="${datas[i].opaProdStockQty}">`,
                                opaProdPrice: `<p id="p_ProdPrice_${datas[i].opaProdNo}">${datas[i].opaProdPrice}</p><input type="text" id="input_ProdPrice_${datas[i].opaProdNo}" class="-none" value="${datas[i].opaProdPrice}">`,
                                opaPrcatsName: datas[i].prcats.opaPrcatsName,
                                opaProdStatus: datas[i].opaProdStatus === 0 ? "未上架" : "已上架",
                                opaProdUpdate: datas[i].opaProdUpdate,
                                action: `<button id="btnDetail_${datas[i].opaProdNo}" class="find_but" onclick="onDetailClick(${datas[i].opaProdNo})">商品詳情</button>  <button id="btnDel_${datas[i].opaProdNo}" class="find_but" onclick="onRemoveClick(${datas[i].opaProdNo})">刪除</button>`
                            }
                            data.push(prod);
                        }
                        $('#prod_table').html(`<table id="table" class="table_style" style="margin: 0 auto"></table>`);
                        $('#table').bootstrapTable({
                            method: "get",
                            striped: true,
                            singleSelect: false,
                            pagination: true, //分頁
                            pageSize: 10,
                            pageNumber: 1,
                            search: false, //顯示搜索框
                            contentType: "application/x-www-form-urlencoded",
                            queryParams: null,
                            columns: [
                                // {
                                //     checkbox: "true",
                                //     field: 'check',
                                //     align: 'center',
                                //     valign: 'middle'
                                // },
                                {
                                    title: "商品圖片",
                                    field: 'prpics',
                                    align: 'center',
                                    valign: 'middle'
                                },
                                {
                                    title: "商品編號",
                                    field: 'opaProdNo',
                                    align: 'center',
                                    valign: 'middle'
                                },
                                {
                                    title: "商品名稱",
                                    field: 'opaProdName',
                                    align: 'center',
                                    valign: 'middle'
                                },
                                {
                                    title: "庫存數量",
                                    field: 'opaProdStockQty',
                                    align: 'center',
                                    valign: 'middle'
                                },
                                {
                                    title: "商品價格",
                                    field: 'opaProdPrice',
                                    align: 'center',
                                    valign: 'middle'
                                },
                                {
                                    title: "商品類別",
                                    field: 'opaPrcatsName',
                                    align: 'center',
                                    valign: 'middle'
                                },
                                {
                                    title: "商品狀態",
                                    field: 'opaProdStatus',
                                    align: 'center',
                                    valign: 'middle'
                                },
                                {
                                    title: "更新日期",
                                    field: 'opaProdUpdate',
                                    align: 'center',
                                    valign: 'middle'
                                },
                                {
                                    title: "",
                                    field: 'action',
                                    align: 'center',
                                    valign: 'middle'
                                }
                            ],
                            data: data
                        });
                    });
            }
        }
    </script>

    <script>
        var imgBase64Array = [];
        function getImgBase64Array() {
            const add_img_els = document.querySelectorAll(".add_img-bg");
            imgBase64Array = [];
            for (let add_img_el of add_img_els) {
                let style = add_img_el.currentStyle || window.getComputedStyle(add_img_el, false);
                let img_url = style.backgroundImage.slice(4, -1).replace(/"/g, "");
                let prpics = {
                    opaProdNo: null,
                    opaProdPicture: img_url
                }
                imgBase64Array.push(prpics);
            }
            return imgBase64Array;
        }
    </script>

    <script>
        $(document).ready(function () {
            ImgUpload();
        });

        function ImgUpload() {
            var imgWrap = "";
            var imgArray = [];

            $('.upload_inputfile').each(function () {
                $(this).on('change', function (e) {
                    imgWrap = $(this).closest('.upload_box').find('.upload_img-wrap');
                    var maxLength = $(this).attr('data-max_length');

                    var files = e.target.files;
                    var filesArr = Array.prototype.slice.call(files);
                    var iterator = 0;
                    filesArr.forEach(function (f, index) {

                        if (!f.type.match('image.*')) {
                            return;
                        }

                        if (imgArray.length > maxLength) {
                            return false;
                        } else {
                            var len = 0;
                            for (var i = 0; i < imgArray.length; i++) {
                                if (imgArray[i] !== undefined) {
                                    len++;
                                }
                            }
                            if (len > maxLength) {
                                return false;
                            } else {
                                imgArray.push(f);

                                var reader = new FileReader();
                                reader.onload = function (e) {
                                    var html = "<div class='upload_img-box'><div style='background-image: url(" + e.target.result + ")' data-number='" + $(".upload_img-close").length + "' data-file='" + f.name + "' class='img-bg add_img-bg'><div class='upload_img-close'></div></div></div>";
                                    imgWrap.append(html);
                                    iterator++;
                                }
                                reader.readAsDataURL(f);
                            }
                        }
                    });
                });
            });

            $('body').on('click', ".upload_img-close", function (e) {
                var file = $(this).parent().data("file");
                for (var i = 0; i < imgArray.length; i++) {
                    if (imgArray[i].name === file) {
                        imgArray.splice(i, 1);
                        break;
                    }
                }
                $(this).parent().parent().remove();
            });
        }
    </script>
    <script>
        function viewImgs(img_id) {
            var main = document.getElementById("img_main_view");
            main.src = img_id.src;
        }
    </script>
</body>

</html>