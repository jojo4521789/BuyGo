<html xmlns="http://www.w3.org/1999/xhtml">

<head>
    <meta http-equiv="Content-Type" content="text/html" ; charset="utf-8" />
    <title>訂單管理</title>

    <link href="css/all.css" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <link href="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.css" rel="stylesheet">
    <link href="//cdnjs.cloudflare.com/ajax/libs/x-editable/1.5.0/bootstrap3-editable/css/bootstrap-editable.css" rel="stylesheet"/>

</head>

<body>
    <p>
    <table id="table" class="table_style" style="margin: 0 auto"></table>
    </p>

    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.0.min.js" integrity="sha256-2Pmvv0kuTBOenSvLm6bvfBSSHrUJ+3A7x6P5Ebd07/g=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/x-editable@1.5.1/dist/bootstrap3-editable/js/bootstrap-editable.min.js"></script>
    <script src="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.js"></script>
    <script src="https://unpkg.com/bootstrap-table@1.22.1/dist/extensions/editable/bootstrap-table-editable.min.js"></script>
    <script src="https://unpkg.com/bootstrap-table@1.22.1/dist/extensions/filter-control/bootstrap-table-filter-control.min.js"></script>
    <script src="js/const.js"></script>
    <script src="js/order.js"></script>
    <script>
        function statusFormatter(v, row, index, field) {
            var value = row.opaSoStatus;
            return OPA_ORDER_STATUS_MAPPING[value];
        }

        function payStatusFormatter(v, row, index, field) {
            value = row.opaRealStatus;
            return OPA_ORDER_PAY_STATUS_MAPPING[value];
        }

        function failedReasonFormatter(v, row, index, field) {
            value = row.opaFailedReason;
            return OPA_FAILED_REASON_MAPPING[value];
        }

        function operationFormatter(v, row, index, field) {
            var value = row.opaSoNo;
            return '<button onclick="sendNotification(' + value + ')" class="btn btn-primary">發送通知</button>';
        }

        function sendNotification(id) {
            // send post request to change status
            $.ajax({
                url: ROOT_URL + "/needLoginApi/admin/opa/order/notify",
                type: "POST",
                data: {
                    "id": id
                },
                success: function (data) {
                    if (data.successful) {
                        if(data.message) {
                            alert(data.message);
                        } else {
                            alert("發送成功");
                        }
                    } else {
                        if(data.message)
                            alert(data.message);
                        else
                            alert("發送失敗");
                    }
                },
                error: function (e) {
                    if(e.status == 401) {
                        alert("帳號未登入，將導轉置登入頁面");
                        window.location.href = LOGIN_PAGE;
                        return;
                    }
                    alert("發送失敗");
                }
            });
        }


        $().ready(function () {
            $('#table').bootstrapTable({
                url: ROOT_URL + '/needLoginApi/admin/opa/order',
                pagination: true,
                filterControl: true,
                columns: [
                    {
                        field: 'opaSoNo',
                        title: '平台訂單編號',
                        filterControl: 'input',
                        sortable: true
                    },
                    {
                        field: 'opaSoStatus',
                        title: '平台訂單狀態',
                        formatter: statusFormatter,
                        filterControl: 'select',
                        filterData: 'var:OPA_ORDER_STATUS_FILTER',
                        sortable: true,
                        editable: {
                            type: 'select',
                            source: OPA_ORDER_STATUS
                        }
                    },
                    {
                        field: 'opaSoDate',
                        title: '平台訂單日期',
                        sortable: true
                    },
                    {
                        field: 'opaProdTotal',
                        title: '平台商品總金額',
                        filterControl: 'input',
                        sortable: true
                    },
                    {
                        field: 'opaDiscount',
                        title: '優惠券折抵金額',
                        filterControl: 'input',
                        sortable: true
                    },
                    {
                        field: 'opaFirAmount',
                        title: '第一次付款金額',
                        filterControl: 'input',
                        sortable: true
                    },
                    {
                        field: 'opaSecAmount',
                        title: '第二次付款金額',
                        filterControl: 'input',
                        sortable: true
                    },
                    {
                        field: 'opaTotal',
                        title: '平台訂單總金額',
                        filterControl: 'input',
                        sortable: true
                    },
                    {
                        field: 'opaRealTotal',
                        title: '實際付款金額',
                        filterControl: 'input',
                        sortable: true
                    },
                    {
                        field: 'opaRealStatus',
                        title: '實際付款狀態',
                        formatter: payStatusFormatter,
                        filterData: 'var:OPA_ORDER_PAY_STATUS_FILTER',
                        filterControl: 'select',
                        sortable: true
                    },
                    {
                        field: 'opaFailedReason',
                        title: '訂單失敗原因',
                        formatter: failedReasonFormatter,
                        filterData: 'var:OPA_FAILED_REASON_FILTER',
                        filterControl: 'select',
                        sortable: true,
                        editable: {
                            type: 'select',
                            source: OPA_FAILED_REASON
                        }
                    },
                    {
                        field: 'operation',
                        title: '操作',
                        formatter: operationFormatter
                    }
                ], 
                onEditableSave: function(field, row, rowIndex, oldValue, $el) {
                    var id = row.opaSoNo;
                    var value = row.opaSoStatus;
                    
                    var failed_value = -1;
                    if(row.opaFailedReason !== undefined) {
                        failed_value = row.opaFailedReason;
                    }
                    $.ajax({
                        url: ROOT_URL + "/needLoginApi/admin/opa/order?id=" + id + "&status=" + value + "&failed=" + failed_value,
                        type: "PUT",
                        success: function (data) {
                            if (data.successful) {
                                alert("修改成功");
                            } else {
                                alert("修改失敗");
                                $el.attr('value', oldValue);
                            }
                        },
                        error: function (e) {
                            if(e.status == 401) {
                                alert("帳號未登入，將導轉置登入頁面");
                                window.location.href = LOGIN_PAGE;
                                return;
                            }
                            alert("修改失敗");
                            $el.attr('value', oldValue);
                        }
                    });
                },
                onLoadError: function(status, jqXHR) {
                    if(status == 401) {
                        alert("帳號未登入，將導轉置登入頁面");
                        window.location.href = LOGIN_PAGE;
                    }
                }
            })
        });
    </script>
    <style>
        table th {
            vertical-align: top!important;
        }
    </style>
</body>

</html>